name: Android Appium Tests

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    build:
        runs-on: self-hosted
        env:
            TZ: 'Asia/Seoul'

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Ensure No Existing Appium Process
              run: |
                  # Appium 프로세스가 실행 중인지 확인하고 종료합니다.
                  $appiumProcesses = Get-Process | Where-Object { $_.Path -like "*appium*" }
                  if ($appiumProcesses) {
                      $appiumProcesses | Stop-Process -Force
                      echo "기존 Appium 프로세스를 종료했습니다."
                  } else {
                      echo "실행 중인 Appium 프로세스가 없습니다."
                  }

            - name: Run Appium Server
              run: |
                  echo "Appium 서버를 실행합니다..."
                  node C:\Users\monthlykitchen\AppData\Roaming\npm\node_modules\appium\build\lib\main.js
                  timeout /t 20  # 서버가 준비될 때까지 대기

            - name: Run Tests on Real Device
              run: |
                  echo "실제 디바이스에서 테스트를 실행합니다..."
                  node project/test.js

            - name: Upload Appium Log
              uses: actions/upload-artifact@v3
              with:
                  name: appium-log
                  path: appium.log
